# 编码、加密与哈希

我们先拿一个v2链接：

    http://img4.tuwandata.com/v2/thumb/jpg/YTczZiw2MjQsMCw5LDMsMSwtMSxOT05FLCwsOTA=/u/res.tuwan.com/zipgoods/20180616/581914b801ceecf8512682bc949ff21e.jpg

其中的“神秘代码1”部分，`YTczZiw2MjQsMCw5LDMsMSwtMSxOT05FLCwsOTA=`，使用base64进行解码便可以得到`a73f,624,0,9,3,1,-1,NONE,,,90`。这其中用逗号分隔的每个部分分别都起到什么样的作用呢？

[根据前人的研究成果][1]，在相册提供的v3缩略图链接中，第二、三个字段都是158，而链接指向的便是一个158*158像素的图片。将这两个字段改为0，重新使用base64编码，并替换原链接中的神秘代码，新链接便指向全尺寸的图片。
那么很明显，第二、三字段便是控制图片缩放的宽和高，而0可能指的是“自动”。例如我们手头这个链接，第二三字段分别为624和0，于是链接指向的果然是一个宽度为624像素的图片。

尝试修改其他字段的值，然后观察链接指向的图片有什么变化，可以发现：

* 第四个字段的9控制缩放和剪切图片的方式。例如，设为0时，图片不进行缩放；设为1时，仅缩放宽度；2仅缩放高度；3直接按照提供的宽和高进行缩放，无视宽高比；等等等等。

* 最后一个字段，控制jpg格式的图片质量，100为最高质量。

* 中间那几个字段，简单试了试，似乎没看出什么作用。发掘这些字段的作用就是留给读者的作业啦~

总之，这些字段控制图片的缩放、裁剪、格式转换之类的处理参数，修改之后总还是会返回一张图片的。
但是第一个字段跟其他的都不一样，只要修改了，就会返回404。
显然这个字段的作用也和其他的不一样，可以推测是一种访问控制。

有了这些发现之后，我们就可以对这些链接的作用以及演化过程做出一些推测了。
回忆一下上一章总结出来的链接格式：

    http://img4.tuwandata.com/{版本}/thumb/{格式}/{神秘代码1}/u/{神秘代码2}

{神秘代码2}是源图片的真实地址，{格式}和{神秘代码1}的大部分字段控制图片需要经过哪些处理和格式转换。
在v2链接中，两段神秘代码都是明码，源图片的真实地址直接暴露了出来。
为了保护真实地址，用某种编码或者加密方法处理了神秘代码2，并把版本升级到v3。
大家发现了只要修改神秘代码1里面的字段，就可以将缩略图的链接改成全尺寸链接。为了阻断这种白嫖行为，所以升级到v4的时候把神秘代码1也进行了保护。

那么，现在不明确的还有两个问题：

1. 在v3和v4链接中，保护两段神秘代码的究竟是什么编码/加密算法？有可能将其破解吗？

2. base64明文神秘代码1的第一个字段究竟是什么呢？

问题2看起来更加简单，就从这里开始吧。
首先收集所有能找到的v2链接，将它们的神秘代码1进行解码，并观察第一个字段。
很容易就能获取以下信息：

* 长度总是4个字符
* 每个字符都在`[0-9a-f]`的范围内
* 字符的分布非常均匀
* 两个不同的链接，该字段有可能有相同的

通过最后一点，已经可以排除“该字段是一个数据库里的唯一标识符”的可能性了，而前三点则有一股闻起来很像某种哈希算法的气味。
究竟是什么呢？

*未完待续……*

[1]: https://sbcoder.cn/2019/05/13/tuwan_spider.html